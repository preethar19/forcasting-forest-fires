---
title: "forcasting forest fires"
author: "fantastic fouR: Eli Levine, Hannah Long, Preetha Ramachandran"
date: "Oct. 26, 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
```

Your written report goes here! Before you submit, make sure your code chunks are turned off with `echo = FALSE` and there are no warnings or messages with `warning = FALSE` and `message = FALSE` 

```{r load-packages}
library(tidyverse)
library(broom)
library(patchwork)
library(knitr)
library(yardstick)
library(Stat2Data)
library(rms)
```

```{r load-data}
fire <- readr::read_csv('data/all_conditions.csv')
```

### Introduction

Climate change represents an existential threat to humanity. Its effects have 
the potential to dramatically shape life as we know it, creating climate refugees, 
resource wars, and submerging major cities around the globe. However, unlike 
previous challenges to our way of life, the threat of climate change will not 
manifest in a single event, rather in a series of natural disasters that will 
eventually escalate to a point where we no longer have the resources to manage 
them. This is being seen already in California as wildfires sweep the state, 
forcing people to relocate, causing issues with access and use of electricity and 
causing an estimated $10 billion in damages. Thus, in our project, we plan to 
determine what are the strongest environmental predictors of forest fires by 
looking at data from California. 

It is important to understand what these predictors are to determine how to 
prevent short term fires from escalating and to correct these conditions in the 
long run to see if it is possible to mitigate the threat of these fires going 
forward. If we know what predictors play a role in a fire, it can help authorities 
better understand what days or seasons present a higher risk, and thus prepare 
accordingly. While climate change will continue to affect our way of life, 
insights into how to manage its consequences and effects will help us plan for 
both the short term and long term future, at least until policy and research 
catch up to the severity of the issue.

The data we will be using was scraped from CIMIS (California Irrigation 
Management Information System) weather stations by github user czaloumi using a 
selenium chromedriver. The dataset was combined with Wikipedia tables listing 
California fires by county and city to create the Target column, which indicates 
whether or not there was a fire on a particular day. Additionally, the curator 
of the dataset adds that this dataset was “used in conjunction to building an 
XGBoost Classifier to accurately predict probability for fire given environmental 
condition feature.” This user’s data contains a mixture of environmental and 
geospatial data to understand the size and the scope of the forest fires, as well 
as where the fires seem to be most frequent.

```{r}
newfire <- fire %>% 
  mutate(ETo = `ETo (in)`,
         precip = `Precip (in)`,
         solrad = `Sol Rad (Ly/day)`,
         avgvappress = `Avg Vap Pres (mBars)`,
         maxairtemp = `Max Air Temp (F)`,
         avgsoiltemp = `Avg Soil Temp (F)`,
         windrun = `Wind Run (miles)`,
         avgwindspeed = `Avg Wind Speed (mph)`,
         dewpoint = `Dew Point (F)`,
         avgrelhum = `Avg Rel Hum (%)`,
         minrelhum = `Min Rel Hum (%)`,
         maxrelhum = `Max Rel Hum (%)`,
         avgairtemp = `Avg Air Temp (F)`,
         minairtemp = `Min Air Temp (F)`)
```

However, due to the size and scope of our data set, we decided to adjust 
accordingly. Each of the stations in our data contains data between 2018 and 
summer 2020. To correct for this, we will be randomly selecting a day from each 
of the sections within this range, and focusing more so on what each station 
reported from its respective day. This will give us 153 observations instead of 
128,126. We decided that trimming it down would not only reduce the data, but 
also reduce the noise. 

```{r}
set.seed(19)

newestfire <- newfire %>% 
  group_by(`Stn Id`) %>% 
  sample_n(1, replace = TRUE)
```

From day-to-day in a station it is unlikely that there is 
substantial variation, however when comparing station to station over different 
days, we are able to see different variables from all times of the year.
However, there was still some missing data, so our total number of observations 
has been further reduced to 143, from stations all across the state of California.


```{r}
newestfire <- newestfire %>% 
  drop_na()
```

Our first step of our exploratory data analysis was to look at the shape of the
distributions of each variable. This would give us a sense about which 
transformations might be necessary.

```{r fig.width = 15, fig.height = 15}
p1 <- ggplot(data = newestfire, aes(x = ETo)) +
  geom_histogram(stat = "count", fill = "red") +
  labs(x = "ETo (in)",
       y = "Count",
       title = "Distribution of ETo (in)") +
  theme_minimal()

p2 <- ggplot(data = newestfire, aes(x = precip)) +
  geom_histogram(stat = "count", fill = "lightblue") +
  xlim(0,0.5) +
  ylim(0,10) +
  labs(x = "Precip (in)",
       y = "Count",
       title = "Distribution of Precip (in)") +
  theme_minimal()

p3 <- ggplot(data = newestfire, aes(x = solrad)) +
  geom_histogram(stat = "count", fill = "orange") +
  labs(x = "Sol Rad (Ly/day)",
       y = "Count",
       title = "Distribution of Sol Rad (Ly/day)") +
  theme_minimal()

p4 <- ggplot(data = newestfire, aes(x = avgsoiltemp)) +
  geom_histogram(stat = "count", fill = "brown") +
  labs(x = "Avg Soil Temp (F)",
       y = "Count",
       title = "Distribution of Avg Soil Temp (F)") +
  theme_minimal()

p5 <- ggplot(data = newestfire, aes(x = windrun)) +
  geom_histogram(stat = "count", fill = "green") +
  labs(x = "Wind Run (miles)",
       y = "Count",
       title = "Distribution of Wind Run (miles)") +
  theme_minimal()

p6 <- ggplot(data = newestfire, aes(x = avgwindspeed)) +
  geom_histogram(stat = "count", fill = "navyblue") +
  labs(x = "Avg Wind Speed (mph)",
       y = "Count",
       title = "Distribution of Avg Wind Speed (mph)") +
  theme_minimal()

p7 <- ggplot(data = newestfire, aes(x = dewpoint)) +
  geom_histogram(stat = "count", fill = "pink") +
  labs(x = "Dew Point (F)",
       y = "Count",
       title = "Distribution of Dew Point (F)") +
  theme_minimal()

p8 <- ggplot(data = newestfire, aes(x = avgrelhum)) +
  geom_histogram(stat = "count", fill = "salmon") +
  labs(x = "Avg Relative Humidity (%)",
       y = "Count",
       title = "Distribution of Avg Relative Humidity (%)") +
  theme_minimal()

p9 <- ggplot(data = newestfire, aes(x = minrelhum)) +
  geom_histogram(stat = "count") +
  labs(x = "Min Relative Humidity (%)",
       y = "Count",
       title = "Distribution of Min Relative Humidity (%)") +
  theme_minimal()

p10 <- ggplot(data = newestfire, aes(x = maxrelhum)) +
  geom_histogram(stat = "count", fill = "black") +
  labs(x = "Max Relative Humidity (%)",
       y = "Count",
       title = "Distribution of Max Relative Humidity (%)") +
  theme_minimal()

p11 <- ggplot(data = newestfire, aes(x = avgvappress)) +
  geom_histogram(stat = "count", fill = "purple") +
  labs(x = "Avg Vap Pres (mBars)",
       y = "Count",
       title = "Distribution of Avg Vap Pres (mBars)") +
  theme_minimal()

p12 <- ggplot(data = newestfire, aes(x = maxairtemp)) +
  geom_histogram(stat = "count", fill = "blue") +
  labs(x = "Max Air Temp (F)",
       y = "Count",
       title = "Distribution of Max Air Temp (F)") +
  theme_minimal()

p13 <- ggplot(data = newestfire, aes(x = minairtemp)) +
  geom_histogram(stat = "count", fill = "lightblue") +
  labs(x = "Min Air Temp (F)",
       y = "Count",
       title = "Distribution of Min Air Temp (F)") +
  theme_minimal()

p14 <- ggplot(data = newestfire, aes(x = avgairtemp)) +
  geom_histogram(stat = "count", fill = "hotpink") +
  labs(x = "Avg Air Temp (F)",
       y = "Count",
       title = "Distribution of Avg Air Temp (F)") +
  theme_minimal()

(p1 + p2 + p3)/(p4 + p5) + (p6 + p7)/(p8 + p9 + p10) + (p11 + p12) + (p13 + p14)
```
In general it appears as thought the data points tend to follow a normal 
distribution.  However, not all normal distributions are made equal. Maximum 
relative humidity appears to be left skewed, while precipitation appears to be 
right skewed. While it appears that some have multiple peaks and unique spreads 
and distributions this is likely due to limited data points.

### Methodology

To reduce the multicollinearity, we decided to focus on only 
specific variables. For example, the dataset included the average, minimum and 
maximum for a number of variables. We determined that average was likely most 
relevant to the conditions recorded by each station throughout the day.

Since we are trying to predict with a binary response variable, we will use a 
logisitic regression. However, to be able to use a logisitic regression we need
to check the conditions, and ensure that the data satsifies linearity, randomness
and independence.


To check linearity, we will make an empirical logisrtic regression plot for each 
of the predictor variables.

```{r fig.width = 7, fig.height = 3}


emplogitplot1(Target ~ ETo, data = newestfire, 
                  ngroups = 10)
emplogitplot1(Target ~ solrad, data = newestfire, 
                  ngroups = 10)
emplogitplot1(Target ~ avgvappress, data = newestfire, 
                  ngroups = 5)
emplogitplot1(Target ~ avgsoiltemp, data = newestfire, 
                  ngroups = 5)
emplogitplot1(Target ~ windrun, data = newestfire, 
                  ngroups = 5)
emplogitplot1(Target ~ avgwindspeed, data = newestfire, 
                  ngroups = 10)
emplogitplot1(Target ~ dewpoint, data = newestfire, 
                  ngroups = 5)
emplogitplot1(Target ~ avgrelhum, data = newestfire, 
                  ngroups = 10)
emplogitplot1(Target ~ avgairtemp, data = newestfire, 
                  ngroups = 5)
emplogitplot1(Target ~ precip, data = newestfire, 
                 ngroups = 2)

```
After looking at these graphs, it is apparent that average wind speed, and average
relative humidity do not follow a linear relationship. Furthermore, linearity is
only satisfied for precipitation when there are only 2 groups. This means that a
linear model might not be an appropriate estimation for precipitation.

A lot of the data in the dataset is conditional instead of random. The conditions 
recorded by one station will likely be similar to those in a nearby station and 
similar to the recordings the day before. To correct for that, we took a random 
sample of the days in our data set. This also supports independence. Our cleaning 
of the data to include a random sample of days and stations.

Now that we have cleaned the data and satisfied the conditions of logistic 
regression, we began to build prediction models, and eliminated the variables 
that do not satisfy the conditions. Then we will use backward selection to reduce 
the data.

```{r}
fire_model <- glm(Target ~ ETo + solrad + avgvappress + avgsoiltemp + windrun + dewpoint + avgairtemp, data = newestfire, 
                  family = "binomial")
tidy(fire_model)
```

```{r}
vif(fire_model)
```
Now that we see the variation inflation factors of each of the variables, we can 
reduce the multicollinearity by eliminating data points where one has a similar 
VIF to another. Thus we removed solar radiation and dew point, due to its 
multicollineaity with average air temperature and ETo respectively.

```{r}
#removed variables with high multicollinearity: solrad, dewpoint
main_fire_model <- glm(Target ~ ETo + avgvappress + avgsoiltemp + windrun + avgairtemp, data = newestfire, 
                  family = "binomial")
tidy(main_fire_model) %>%
  kable(digits = 3)
```

```{r}
vif(main_fire_model)
```


((drop-in deviance to see what variables are significant))
((ROC curve to find threshold for prediciton "final model"))

```{r}
new_fire_model <- step(main_fire_model, direction = "backward")
tidy(new_fire_model, conf.int = TRUE) %>%
  kable(digts = 3)
```
This model only has three predictors, so we transformed some variables to see if 
that would give further insight. quadratic trans formation for wind speed and 
humidity, by looking at empirical log plot and observing shape

```{r}
glance(new_fire_model)%>%
  select(AIC, BIC) %>%
  kable(digits = 3)
```

((AIC, BIC, Adj R to determine ))


```{r}
#main model, with quadratic transformation on avgwindspeed and avgrelhum
fire_model2 <- glm(Target ~ ETo + avgvappress + avgsoiltemp + windrun + avgairtemp + I(avgwindspeed^2)  + I(avgrelhum^2), data = newestfire, 
                  family = "binomial")
tidy(fire_model2) %>%
  kable(digits = 3)
```

```{r}
fire_model3 <- step(fire_model2, direction = "backward")
tidy(fire_model3, conf.int = TRUE) %>%
  kable(digits = 3)
```

```{r}
glance(fire_model3) %>%
  kable(digits = 3)
```

With quadratic transformed variables, AIC has marginal improvement, but BIC is
larger. So, it is optimal to stick with the model without quadratic 
transformation of variables.

```{r}
interaction_fire_model <- glm(Target ~ ETo + avgsoiltemp * avgairtemp + avgvappress + avgwindspeed * windrun + avgrelhum, data = newestfire, 
                  family = "binomial")
tidy(interaction_fire_model) %>%
  kable(digits = 3)
```

```{r}
anova(main_fire_model, interaction_fire_model, test = "Chisq") %>%
  tidy() %>%
  kable(digits = 3)
```
Due to a high p-value, the data provided is insufficient to provide evidence to 
conclude that the interaction terms are statistically significant. 

After all these analyses/tests, our ultimate best model is new_fire_model.

Since new_fire_model appears to be our strongest model, that means that ETO, 
average air temperature and average soil temperature are the most significant 
environmental predictors of forest fires in California. While this might mean 
that monitoring these three will provide a reduction strategy to fires, it creates 
some ethical questions. ETO is ethylene oxygen is a flammable colorless gas, that 
can not be simply removed from the atmosphere without introducing another agent. 
Furthermore, managing average temperature also provides a number of practical 
issues, as does managing soil temperature. Thus, is it too late to be able to do 
anything effectively to prevent or can fire fighting measures only be reactive 
from this point forward.





------------ notes -------------------------------------------------------------
- picked variables that need transformation (rel humidity, sol rad, precip) 
      - log transform?
- build model, backward assumption


variables we want to keep:
- average humidity
multicollinearity w min and max, we think humidity prob has some effect on fire (water in air???)
- avg air temp 
multicolinearity w min and max air temp

things to do after building model w everything:
- log transform precipitaion??
it looks funny
- sol radiation
closely related to soil temperature (MAKE PLOT FOR THIS FIRST)
- dew point//temperature//humidity
- wind run//wind speed


